version: '1.0'
steps:

  build-step:
    description: Building the image.
    type: build
    dockerfile: Dockerfile
    image-name: advance512demo/demochat
    tag: codefresh
    when:
      - condition: "'${{CF_BRANCH}}' == 'conditional_step'"
      - name: "Bad syntax"
        condition: "2 * 3 <> 55"

  another-clone-step:
    type: git-clone
    description: Another clone step
    repo: github.com/containers101/demochat

  unit-test-via-gulp:
    description: Running unit test via gulp.
    image: monostream/nodejs-gulp-bower:latest
    fail-fast: false
    working-directory : ${{initial-clone}}
    commands:
      - npm install
      - gulp test
      - echo $(date)
    when:
      - name: "Branch is test_me"
        condition: "'${{CF_BRANCH}}' == 'test_me'"
      - name: "Branch is test_him"
        condition: "'${{CF_BRANCH}}' == 'test_him'"
      - name: "Branch is test_her"
        condition: "'${{CF_BRANCH}}' == 'test_her'"
      - name: "2 * 3 is 6"
        condition: "2 * 3 == 6"
       
  unit-test-via-npm:
    description: Running unit test via npm.
    image: ${{build-step}}
    fail-fast: false
    commands:
      - npm test
      - echo $(date)
    when:
      - name: "Verify CONDITION (ignore case) is in branch name"
        condition: "match('${{CF_BRANCH}}', 'CONDITION', true)"
      - condition: "5 == 3 + 2"
      - condition: "'${{CF_COMMIT_MESSAGE}}' == 'hi'"
      - condition: "Variable('initial-clone').commitMessage == 'hi'"
      
  composition-step:
    description: Attempting to run as part of composition.
    type: composition
    composition: 
      version: '2'
      services:
        app:
          image: 'advance512demo/demochat:master'
          ports:
            - 5000
          depends_on:
            - mongo
        mongo:
          image: mongo
    composition-candidates:
      main:
        image: nhoag/curl
        command: bash -c "sleep 20 && curl http://app:5000/" | echo 'works'
    when:
      - name: "Verify CONDITION is in branch name"
        condition: "match('${{CF_BRANCH}}', 'CONDITION', false)"

  push-step:
      description: Pushing image to Docker hub.
      type: push
      candidate: ${{build-step}}
      tag: ${{CF_BRANCH}}        
      when:
        - name: ""
          condition: "'${{CF_BRANCH}}' == 'master'"

